<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Python Editor + Realtime Coach + Test</title>

  <style>
    :root{
      --bg:#f3f5f8; --card:#fff; --border:#e6eaf0; --muted:#667085; --text:#101828;
      --out-bg:#0b1220; --out-text:#e6f2ff; --out-muted:#9bb4d0; --danger:#ff4d4f; --ok:#2ecc71;
      --btn:#1677ff; --btn-hover:#0f63d6; --btn2:#e9f2ff; --btn2-text:#0b5ed7;
      --coach-accent:#0b5ed7; --coach-soft:#eef6ff;
      --stmt-bg:#ffffff;
      --stmt-border:#dbeafe;
      --stmt-title:#0b5ed7;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .page{ max-width:1200px; margin:18px auto; padding:0 14px 18px; display:flex; flex-direction:column; gap:14px; }
    .editor-card{ background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; box-shadow:0 8px 22px rgba(16,24,40,.06); }

    .editor-toolbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-bottom:1px solid var(--border); background:#fff; gap:12px; flex-wrap:wrap;
    }
    .toolbar-left{ display:flex; align-items:center; gap:10px; min-width:240px; flex:1 1 320px; }
    .dot{ width:10px;height:10px;border-radius:50%; background:#d0d5dd; }
    .title{ font-weight:900; font-size:14px; }
    .sub{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:520px; }
    .toolbar-mid{ display:flex; align-items:center; gap:10px; flex:1 1 360px; min-width:280px; }
    select{ width:100%; max-width:520px; padding:9px 10px; border-radius:10px; border:1px solid var(--border); background:#fff; font-size:13px; outline:none; }
    .toolbar-right{ display:flex; align-items:center; gap:10px; }

    .btn{ border:0; background:var(--btn); color:#fff; padding:9px 14px; border-radius:10px; cursor:pointer; font-weight:900; font-size:13px; }
    .btn:hover{ background:var(--btn-hover); }
    .btn2{ border:1px solid #cfe3ff; background:var(--btn2); color:var(--btn2-text); padding:9px 14px; border-radius:10px; cursor:pointer; font-weight:900; font-size:13px; }

    .status{ font-size:12px; color:var(--muted); white-space:nowrap; }
    .pill{ display:inline-block; padding:3px 10px; border-radius:999px; font-size:12px; font-weight:900; background:#eef2ff; color:#344054; border:1px solid var(--border); }
    .pill.ok{ background:#e9fff0; color:#0a7a2a; border-color:#bff0cd; }
    .pill.bad{ background:#ffecec; color:#b00020; border-color:#ffb7b7; }

    /* ƒê·ªÅ b√†i */
    .statementbar{ padding:12px 12px; border-bottom:1px solid var(--border); background:#fff; }
    .statementbox{ background:var(--stmt-bg); border:2px solid var(--stmt-border); border-radius:14px; padding:14px 14px; }
    .statementtitle{ font-weight:1000; font-size:18px; color:var(--stmt-title); margin:0 0 8px 0; line-height:1.2; }
    .statementtext{ margin:0; font-size:16px; line-height:1.55; white-space:pre-wrap; color:#123b63; }

    /* Coach */
    .coachbar{ padding:10px 12px; border-bottom:1px solid var(--border); background:#fff; display:flex; gap:10px; align-items:flex-start; }
    .coach-left{ flex:1 1 auto; min-width:280px; }
    .coach-title{ font-size:12px; font-weight:900; color:var(--coach-accent); margin-bottom:6px; }
    .coach-next{ font-size:12px; line-height:1.35; background:var(--coach-soft); border:1px solid #d9ebff; padding:8px 10px; border-radius:10px; white-space:pre-wrap; color:#123b63; }
    .coach-right{ flex:0 0 360px; max-width:420px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 10px; }
    .checklist{ margin:0; padding-left:18px; font-size:12px; color:#123b63; line-height:1.55; }
    .checklist .ok{ color:#0a7a2a; font-weight:900; } .checklist .no{ color:#b00020; font-weight:900; }
    @media (max-width: 920px){ .coachbar{ flex-direction:column; } .coach-right{ width:100%; max-width:none; } }

    /* Monaco */
    .code-wrap{ height:430px; position:relative; background:#fff; }
    @media (max-width: 920px){ .code-wrap{ height:360px; } }
    #editor{ height:100%; border-top:1px solid var(--border); }

    /* Output panels */
    .bottom{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width: 920px){ .bottom{ grid-template-columns:1fr; } select{ max-width:none; } }
    .panel{ background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; box-shadow:0 8px 22px rgba(16,24,40,.06); min-height:220px; }
    .panel-head{ padding:10px 12px; border-bottom:1px solid var(--border); background:#fff; }
    .panel-title{ font-weight:900; font-size:14px; margin:0; }
    .panel-sub{ margin-top:2px; font-size:12px; color:var(--muted); white-space:pre-wrap; line-height:1.35; }
    .stdin{ width:100%; height:170px; border:0; outline:none; resize:none; padding:12px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; font-size:14px; line-height:1.5; background:#fff; }
    .out{ width:100%; height:170px; padding:12px; background:var(--out-bg); color:var(--out-text);
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; font-size:13px; line-height:1.55; overflow:auto; white-space:pre-wrap; }
    .out .x{ color:var(--danger); font-weight:900; } .out .muted{ color:var(--out-muted); }
    .out .ok{ color:var(--ok); font-weight:900; } .out .hint{ color:#b7d7ff; font-weight:900; }
  </style>
</head>

<body>
<div class="page">

  <div class="editor-card">
    <div class="editor-toolbar">
      <div class="toolbar-left">
        <div class="dot"></div>
        <div style="min-width:0">
          <div class="title">Python</div>
          <div class="sub" id="subtitle">Vi·∫øt code ·ªü ƒë√¢y ‚Ä¢ Realtime Coach ‚Ä¢ Test PASS/FAIL</div>
        </div>
      </div>

      <div class="toolbar-mid">
        <select id="problemSelect"></select>
        <span class="pill" id="pill">Ch∆∞a ch·∫°y</span>
        <span class="status" id="scoreMeta">Test: 0/0</span>
      </div>

      <div class="toolbar-right">
        <div class="status" id="status">ƒêang t·∫£i Python...</div>
        <button class="btn2" id="loadBtn" disabled>N·∫°p khung</button>
        <button class="btn2" id="hintBtn" disabled>G·ª£i √Ω</button>
        <button class="btn" id="runBtn" disabled>Test</button>
        <button class="btn2" id="nextBtn" style="display:none;" title="Ch·ªâ hi·ªán khi b·∫°n PASS">B√†i ti·∫øp theo</button>
      </div>
    </div>

    <div class="statementbar">
      <div class="statementbox">
        <div class="statementtitle" id="statementTitle">ƒê·ªÅ b√†i</div>
        <pre class="statementtext" id="statementText">(ƒêang t·∫£i ƒë·ªÅ...)</pre>
      </div>
    </div>

    <div class="coachbar">
      <div class="coach-left">
        <div class="coach-title">üß† Realtime Coach (g·ª£i √Ω theo d√≤ng ƒëang g√µ)</div>
        <div class="coach-next" id="coachNext">(B·∫Øt ƒë·∫ßu g√µ code ƒë·ªÉ nh·∫≠n g·ª£i √Ω t·ª©c th√¨)</div>
      </div>
      <div class="coach-right">
        <div class="coach-title" style="margin-bottom:6px;">Checklist</div>
        <ul class="checklist" id="coachChecklist"></ul>
      </div>
    </div>

    <div class="code-wrap">
      <div id="editor"></div>
    </div>
  </div>

  <div class="bottom">
    <div class="panel">
      <div class="panel-head">
        <p class="panel-title">Input (stdin)</p>
        <div class="panel-sub">Nh·∫≠p d·ªØ li·ªáu ƒë·∫ßu v√†o ƒë·ªÉ ch·∫°y th·ª≠. (Test d√πng test case ri√™ng)</div>
      </div>
      <textarea class="stdin" id="stdin" spellcheck="false"></textarea>
    </div>

    <div class="panel">
      <div class="panel-head">
        <p class="panel-title">Output / L·ªói / PASS-FAIL</p>
        <div class="panel-sub">L·ªói ti·∫øng Vi·ªát + nguy√™n nh√¢n + c√°ch s·ª≠a theo ‚Äúƒë√∫ng b·ªánh‚Äù.</div>
      </div>
      <div class="out" id="out"><span class="muted">Ch∆∞a ch·∫°y.</span></div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>


<!-- Firebase (optional sync) -->
<!-- Firebase Sync (Firestore) - ES Module -->
<script type="module" src="./firebase_sync_module.js"></script>
<script>
  // Session-aware keys (ƒë·ªìng b·ªô theo h·ªçc sinh/gi√°o vi√™n ƒëang ƒëƒÉng nh·∫≠p ·ªü trang cha)
  const SESSION_KEY = "py10:session";
  function getSession(){
    try{ return JSON.parse(localStorage.getItem(SESSION_KEY) || "null"); }catch(_){ return null; }
  }
  const _sess = getSession();
  const _scope = _sess && _sess.id ? String(_sess.id).trim() : "guest";

  // =======================
  // PROBLEMS (5 b√†i c√≥ s·∫µn) + B√ÄI GI√ÅO VI√äN GIAO (t·ª± ch√®n sau B√†i 5)
  // - B√†i GV giao l·∫•y t·ª´: py10:assignments (GV giao) + py10:teacherBank (ƒë·ªÅ ri√™ng GV t·∫°o)
  // - C∆° ch·∫ø kh√≥a theo th·ª© t·ª±: ch·ªâ m·ªü ƒë∆∞·ª£c b√†i GV giao sau khi PASS ƒë·ªß 5 b√†i ƒë·∫ßu.
  // =======================
  // 5 bai co san (co dinh)
  const BASE_PROBLEMS = [
    {
      id:"b1",
      title:"B√†i 1: Ch·∫µn hay l·∫ª (n t·ª± nhi√™n)",
      statement:"Nh·∫≠p m·ªôt s·ªë t·ª± nhi√™n n, in ra th√¥ng b√°o n l√† s·ªë ch·∫µn hay s·ªë l·∫ª.",
      starter:`n = int(input("Nh·∫≠p n: "))\n\n# TODO: In ra th√¥ng b√°o n l√† s·ªë ch·∫µn hay s·ªë l·∫ª\n`,
      sampleInput:"7",
      hints:{
        level1:["B·∫°n c·∫ßn k·∫øt lu·∫≠n 1 trong 2 tr∆∞·ªùng h·ª£p: ch·∫µn ho·∫∑c l·∫ª."],
        level2:["Nh·∫≠p n ‚Üí ki·ªÉm tra n chia 2 d∆∞ hay kh√¥ng ‚Üí in k·∫øt lu·∫≠n."],
        level3:["B·∫°n c·∫ßn if/else. Ch·∫µn/l·∫ª th∆∞·ªùng ki·ªÉm tra b·∫±ng % 2."],
        level4:["Pseudo: n·∫øu n % 2 == 0 ‚Üí ch·∫µn, ng∆∞·ª£c l·∫°i ‚Üí l·∫ª."],
        level5:["N·∫øu l·ªói: ki·ªÉm tra d·∫•u ':' v√† th·ª•t l·ªÅ sau if/else."]
      },
      tests:{
        public:[{input:"2\n",expected:"chan"},{input:"7\n",expected:"le"}],
        hidden:[{input:"0\n",expected:"chan"},{input:"999\n",expected:"le"}]
      },
      checker:(out,expected)=>{
        const o=simplifyText(out);
        if(expected==="chan") return o.includes("chan") || o.includes("so chan") || o.includes("ch·∫µn");
        if(expected==="le") return o.includes("le") || o.includes("so le") || o.includes("l·∫ª");
        return false;
      }
    },
    {
      id:"b2",
      title:"B√†i 2: a chia h·∫øt b (b ‚â† 0)",
      statement:"Nh·∫≠p hai s·ªë nguy√™n a v√† b (b kh√°c 0). In ra th√¥ng b√°o a c√≥ chia h·∫øt cho b hay kh√¥ng.",
      starter:`a = int(input("Nh·∫≠p a: "))\nb = int(input("Nh·∫≠p b (kh√°c 0): "))\n\n# TODO: In ra a c√≥ chia h·∫øt cho b hay kh√¥ng\n`,
      sampleInput:"10\n2",
      hints:{
        level1:["B·∫°n c·∫ßn ki·ªÉm tra chia h·∫øt gi·ªØa a v√† b."],
        level2:["Nh·∫≠p a,b ‚Üí ki·ªÉm tra a chia b d∆∞ 0 hay kh√¥ng ‚Üí in k·∫øt lu·∫≠n."],
        level3:["D√πng if/else v√† ph√©p chia l·∫•y d∆∞ a % b."],
        level4:["Pseudo: n·∫øu a%b==0 ‚Üí chia h·∫øt, else ‚Üí kh√¥ng chia h·∫øt."],
        level5:["N·∫øu l·ªói chia cho 0: ki·ªÉm tra b c√≥ b·∫±ng 0 kh√¥ng."]
      },
      tests:{
        public:[{input:"10\n2\n",expected:"chia het"},{input:"10\n3\n",expected:"khong chia het"}],
        hidden:[{input:"-12\n3\n",expected:"chia het"},{input:"5\n-2\n",expected:"khong chia het"}]
      },
      checker: (out, expected) => {
        const o = simplifyText(out);
        const reChiaHet = /(^|[^a-z0-9])chia\s*het([^a-z0-9]|$)/;
        const reKhongChiaHet = /(^|[^a-z0-9])khong\s+chia\s*het([^a-z0-9]|$)/;
        if (expected === "chia het") return reChiaHet.test(o) && !reKhongChiaHet.test(o);
        if (expected === "khong chia het") return reKhongChiaHet.test(o);
        return false;
      }
    },
    {
      id:"b3",
      title:"B√†i 3: T√≠nh ti·ªÅn ƒëi·ªán theo m·ª©c (kh√¥ng lu·ªπ ti·∫øn)",
      statement:`Nh·∫≠p s·ªë ƒëi·ªán ti√™u th·ª• (kWh).\nT√≠nh ti·ªÅn:\n- ‚â§50: 1678 ƒë/kWh\n- 51‚Äì100: 1734 ƒë/kWh\n- >100: 2014 ƒë/kWh\n(ƒë∆°n gi√° theo m·ª©c, kh√¥ng lu·ªπ ti·∫øn)`,
      starter:`kwh = float(input("Nh·∫≠p kWh: "))\n\n# TODO: T√≠nh ti·ªÅn ƒëi·ªán v√† in ra (ƒë∆°n v·ªã ƒë·ªìng)\n`,
      sampleInput:"60",
      hints:{
        level1:["Chia 3 tr∆∞·ªùng h·ª£p theo kWh."],
        level2:["Nh·∫≠p kWh ‚Üí x√°c ƒë·ªãnh kho·∫£ng ‚Üí nh√¢n ƒë∆°n gi√° ‚Üí in ti·ªÅn."],
        level3:["D√πng if/elif/else v·ªõi bi√™n 50 v√† 100."],
        level4:["Pseudo: kwh<=50 ‚Üí*1678; elif<=100 ‚Üí*1734; else ‚Üí*2014"],
        level5:["N·∫øu sai: ki·ªÉm tra bi√™n v√† ƒë√∫ng ƒë∆°n gi√°."]
      },
      tests:{
        public:[{input:"50\n",expected:83900},{input:"60\n",expected:104040}],
        hidden:[{input:"100\n",expected:173400},{input:"120\n",expected:241680}]
      },
      checker:(out,expected)=>{
        const got=extractFirstNumber(out);
        return got!==null && Math.abs(got-expected)<0.6;
      }
    },
    {
      id:"b4",
      title:"B√†i 4: In c√°c s·ªë t·ª´ 1 ƒë·∫øn n",
      statement:"Nh·∫≠p n. In ra c√°c s·ªë t·ª´ 1 ƒë·∫øn n (c√°ch nhau b·∫±ng kho·∫£ng tr·∫Øng ho·∫∑c xu·ªëng d√≤ng).",
      starter:`n = int(input("Nh·∫≠p n: "))\n\n# TODO: In c√°c s·ªë t·ª´ 1 ƒë·∫øn n\n`,
      sampleInput:"5",
      hints:{
        level1:["C·∫ßn in d√£y 1..n."],
        level2:["Nh·∫≠p n ‚Üí l·∫∑p i=1..n ‚Üí in i."],
        level3:["D√πng for/while. Nh·ªõ bao g·ªìm n."],
        level4:["Pseudo: for i=1..n: print(i)"],
        level5:["N·∫øu thi·∫øu s·ªë: ki·ªÉm tra ph·∫°m vi v√≤ng l·∫∑p."]
      },
      tests:{
        public:[{input:"1\n",expectedTokens:["1"]},{input:"5\n",expectedTokens:["1","2","3","4","5"]}],
        hidden:[{input:"3\n",expectedTokens:["1","2","3"]},{input:"10\n",expectedTokens:["1","2","3","4","5","6","7","8","9","10"]}]
      },
      checker:(out,expected,input,t)=>{
        const tokens=tokenize(out);
        const want=t.expectedTokens;
        if(tokens.length!==want.length) return false;
        for(let i=0;i<want.length;i++) if(tokens[i]!==want[i]) return false;
        return true;
      }
    },
    {
      id:"b5",
      title:"B√†i 5: T·ªïng c√°c s·ªë ch·∫µn t·ª´ 1 ƒë·∫øn n",
      statement:"Nh·∫≠p n. T√≠nh t·ªïng c√°c s·ªë ch·∫µn t·ª´ 1 ƒë·∫øn n v√† in ra k·∫øt qu·∫£.",
      starter:`n = int(input("Nh·∫≠p n: "))\n\n# TODO: T√≠nh t·ªïng c√°c s·ªë ch·∫µn t·ª´ 1 ƒë·∫øn n v√† in ra\n`,
      sampleInput:"10",
      hints:{
        level1:["C·ªông c√°c s·ªë ch·∫µn trong ƒëo·∫°n 1..n."],
        level2:["Nh·∫≠p n ‚Üí l·∫∑p 1..n ‚Üí n·∫øu ch·∫µn th√¨ c·ªông ‚Üí in t·ªïng."],
        level3:["V√≤ng l·∫∑p + l·ªçc ch·∫µn (%2). Nh·ªõ t·ªïng=0."],
        level4:["Pseudo: sum=0; for i=1..n: if i ch·∫µn ‚Üí sum+=i; print(sum)"],
        level5:["N·∫øu sai: ki·ªÉm tra ƒëi·ªÅu ki·ªán ch·∫µn v√† ph·∫°m vi."]
      },
      tests:{
        public:[{input:"1\n",expected:0},{input:"10\n",expected:30}],
        hidden:[{input:"2\n",expected:2},{input:"100\n",expected:2550}]
      },
      checker:(out,expected)=>{
        const got=extractFirstNumber(out);
        return got!==null && Math.abs(got-expected)<0.01;
      }
    }
  ];

  // Danh sach bai dung thuc te trong editor (dong): 5 bai co san + bai GV giao (Bai 6+)
  // Dung "let" de co the rebuild khi GV giao them bai.
  let PROBLEMS = BASE_PROBLEMS.slice();

  // ====== B√†i gi√°o vi√™n giao (append sau 5 b√†i c√≥ s·∫µn) ======
  const ASSIGN_KEY = "py10:assignments";
  const TEACHER_BANK_KEY = "py10:teacherBank";

  function _loadJSON(key, fallback){
    try{
      const v = JSON.parse(localStorage.getItem(key) || "null");
      return (v === null || v === undefined) ? fallback : v;
    }catch(_){
      return fallback;
    }
  }

  function assignmentMatchesStudent(a, sess){
    try{
      if(!a || a.active === false) return false;
      if(!sess || sess.role !== "student") return false;

      const sid = String(sess.id || "").trim();
      let cls = String(sess.class || sess.cls || "").trim();

      // Fallback: n·∫øu session kh√¥ng c√≥ l·ªõp, th·ª≠ ƒë·ªçc t·ª´ roster (py10:roster)
      if(!cls){
        try{
          const roster = _loadJSON("py10:roster", null);
          if(roster && Array.isArray(roster.students)){
            const st = roster.students.find(s => String(s.id||"").trim() === sid);
            if(st) cls = String(st.class || st.cls || "").trim();
          }
        }catch(e){}
      }

      // legacy: a.target = "all" | "class:10A1" | "student:hs1"
      if(typeof a.target === "string"){
        const t = a.target.trim();
        if(t === "all" || t === "everyone") return true;
        if(t.startsWith("class:")) return t.slice(6).trim() === cls;
        if(t.startsWith("student:")) return t.slice(8).trim() === sid;
      }

      const type = String(a.targetType || a.type || "all").toLowerCase();
      if(type === "all" || type === "everyone") return true;

      if(type === "class"){
        const v = String(a.targetValue || a.className || a.class || "").trim();
        return !!v && v === cls;
      }

      if(type === "students" || type === "student"){
        const direct = String(a.targetValue || "").trim();
        if(direct && direct === sid) return true;
        const arr = a.targets || a.studentIds || a.students || [];
        if(Array.isArray(arr)) return arr.map(x=>String(x).trim()).includes(sid);
        return false;
      }

      // fallback: targets array may contain sid
      if(Array.isArray(a.targets)){
        const arr = a.targets.map(x=>String(x).trim());
        return arr.includes(sid);
      }

      return false;
    }catch(e){
      return false;
    }
  }

  function formatDue(iso){
    if(!iso) return "";
    try{
      const d = new Date(String(iso));
      if(isNaN(d.getTime())) return String(iso);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }catch(_){
      return String(iso);
    }
  }

  function buildProblemFromTeacherBank(bankItem, meta){
    const b = bankItem || {};
    const id = String(b.id || "").trim();
    if(!id) return null;

    const titleRaw = String(meta?.title || b.title || ("B√†i GV " + id)).trim();
    const text = String(b.text || b.statement || "").trim();
    const note = String(meta?.note || "").trim();
    const due = String(meta?.due || "").trim();

    let statement = text || "ƒê·ªÅ b√†i (gi√°o vi√™n giao)";
    const extra = [];
    if(note) extra.push("Ghi ch√∫ gi√°o vi√™n: " + note);
    if(due) extra.push("H·∫°n: " + formatDue(due));
    if(extra.length) statement += "\n\n" + extra.join("\n");
    // Tests: ∆∞u ti√™n b.tests[]; fallback sampleIn/sampleOut
    let testList = [];
    if(Array.isArray(b.tests) && b.tests.length){
      testList = b.tests
        .map(t => ({
          input: String(t.stdin ?? t.input ?? ""),
          expected: (t.expected ?? t.output ?? "")
        }))
        .filter(t => String(t.input).length || String(t.expected).length);
    }
    if(!testList.length){
      const inp = String(b.sampleIn ?? b.sampleInput ?? "");
      const exp = String(b.sampleOut ?? b.sampleOutput ?? "");
      if(inp.length || exp.length) testList = [{ input: inp, expected: exp }];
    }
    if(!testList.length){
      // tr√°nh auto-pass khi thi·∫øu test
      testList = [{ input: "", expected: "__MISSING_EXPECTED__" }];
    }

    const starter = (String(b.starter || "").trim())
      ? String(b.starter)
      : `# ${titleRaw}
# Vi·∫øt code c·ªßa b·∫°n ·ªü ƒë√¢y
`;

    const sampleInput = String(b.sampleIn ?? b.sampleInput ?? "");

    return {
      id,
      title: titleRaw, // s·∫Ω ƒë∆∞·ª£c ƒë√°nh s·ªë l·∫°i: B√†i 6,7,...
      statement,
      starter,
      sampleInput,
      hints:{
        level1:["ƒê·ªçc k·ªπ ƒë·ªÅ v√† vi·∫øt t·ª´ng b∆∞·ªõc."],
        level2:["Chia nh·ªè: nh·∫≠p ‚Üí x·ª≠ l√Ω ‚Üí in k·∫øt qu·∫£."],
        level3:["Ch√∫ √Ω ƒë·ªãnh d·∫°ng output (d·∫•u c√°ch, xu·ªëng d√≤ng)."],
        level4:["Th·ª≠ v·ªõi sample tr∆∞·ªõc r·ªìi m·ªõi Test."],
        level5:["N·∫øu FAIL: so s√°nh output c·ªßa b·∫°n v·ªõi expected."],
      },
      tests:{
        public: testList.map(t=>({ input: String(t.input??""), expected: t.expected })),
        hidden:[]
      },
      checker:(out, expected)=>{
        const o = normalizeOutput(out).trim();
        const e = normalizeOutput(String(expected ?? "")).trim();
        return o === e;
      }
    };
  }

  function rebuildProblemsFromAssignments(){
    const base = BASE_PROBLEMS.slice();

    // ch·ªâ h·ªçc sinh m·ªõi c·∫ßn ch√®n b√†i GV giao
    if(!_sess || _sess.role !== "student"){
      PROBLEMS = base;
      return;
    }

    const assignsAll = _loadJSON(ASSIGN_KEY, []) || [];
    const assigns = assignsAll
      .filter(a=>a && a.active !== false)
      .filter(a=>assignmentMatchesStudent(a, _sess));

    const bank = _loadJSON(TEACHER_BANK_KEY, []) || [];
    const bankMap = new Map((Array.isArray(bank)?bank:[])
      .filter(x=>x && x.id)
      .map(x=>[String(x.id).trim(), x]));

    // sort: due g·∫ßn nh·∫•t tr∆∞·ªõc, r·ªìi createdAt c≈© h∆°n tr∆∞·ªõc
    const sorted = assigns.slice().sort((a,b)=>{
      const ad = String(a.due || "9999-12-31");
      const bd = String(b.due || "9999-12-31");
      if(ad != bd) return ad.localeCompare(bd);
      const ac = String(a.createdAt || "");
      const bc = String(b.createdAt || "");
      return ac.localeCompare(bc);
    });

    const added = [];
    const seen = new Set(base.map(p=>p.id));

    for(const a of sorted){
      const lessonId = String(a.lessonId || "").trim();
      if(!lessonId) continue;
      if(seen.has(lessonId)) continue; // tr√°nh tr√πng v·ªõi 5 b√†i c√≥ s·∫µn / tr√πng ƒë·ªÅ

      const bankItem = bankMap.get(lessonId);
      if(!bankItem) continue; // b√†i giao kh√¥ng h·ª£p l·ªá -> b·ªè qua ƒë·ªÉ kh√¥ng l√†m h·ªèng lu·ªìng PASS

      const prob = buildProblemFromTeacherBank(bankItem, { title: a.title, note: a.note, due: a.due });
      if(!prob) continue;

      added.push(prob);
      seen.add(lessonId);
    }

    // ƒê√°nh s·ªë: b·∫Øt ƒë·∫ßu t·ª´ B√†i 6
    const startNo = base.length + 1;
    for(let i=0;i<added.length;i++){
      const raw = String(added[i].title || ("B√†i GV " + added[i].id)).trim();
      const cleaned = raw.replace(/^B√†i\s*\d+\s*:\s*/i, "").trim();
      added[i].title = `B√†i ${startNo + i}: ${cleaned || ("B√†i GV " + added[i].id)}`;
    }

    PROBLEMS = base.concat(added);
  }

  // Build ngay khi load trang (khong de loi lam treo editor)
  try{
    rebuildProblemsFromAssignments();
  }catch(e){
    console.error("rebuildProblemsFromAssignments error", e);
    PROBLEMS = BASE_PROBLEMS.slice();
  }

  // =======================
  // Progress lock (scope theo user)
  // =======================
  const PROGRESS_KEY = `py10:${_scope}:progress_pass_v1`;
  function loadProgress(){
    try{
      const v = JSON.parse(localStorage.getItem(PROGRESS_KEY) || "null");
      return v && typeof v === "object" ? v : { passed:{} };
    }catch(_){ return { passed:{} }; }
  }
  function saveProgress(p){ try{ localStorage.setItem(PROGRESS_KEY, JSON.stringify(p)); }catch(_){}}
  

  // =======================
  // ƒê·ªìng b·ªô K·∫æT QU·∫¢ cho Gi√°o vi√™n (shared keys)
  // Gi√°o vi√™n ƒë·ªçc: py10:progress:<hsid> v√† py10:log:<hsid>
  // =======================
  const T_PROG_KEY = `py10:progress:${_scope}`;
  const T_LOG_KEY  = `py10:log:${_scope}`;
  function tLoadJSON(key, fallback){
    try{ const v = JSON.parse(localStorage.getItem(key) || 'null'); return (v && typeof v==='object') ? v : fallback; }
    catch(_){ return fallback; }
  }
  function tSaveJSON(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(_){} }
  function tLoadProg(){
    const p = tLoadJSON(T_PROG_KEY, {passed:{}, lastSavedAt:null});
    if(!p.passed || typeof p.passed!=='object') p.passed = {};
    return p;
  }
  function tLoadLog(){
    const l = tLoadJSON(T_LOG_KEY, {events:[]});
    if(!Array.isArray(l.events)) l.events = [];
    return l;
  }
  function tPushEvent(ev){
    const l = tLoadLog();
    l.events.push(ev);
    if(l.events.length > 300) l.events = l.events.slice(-300);
    tSaveJSON(T_LOG_KEY, l);
  }
  function syncTeacherResult({ok, lessonId, err, act='test', code, stdin, stdout}){
    const now = new Date().toISOString();
    const prog = tLoadProg();
    if(ok) prog.passed[String(lessonId)] = true;
    prog.lastSavedAt = now;
    tSaveJSON(T_PROG_KEY, prog);
    tPushEvent({at: now, act, ok: !!ok, lessonId: String(lessonId), err: err ? String(err) : ''});
    // Firebase sync (optional)
    try{
      if(window.py10Firebase && window.py10Firebase.enabled){
        window.py10Firebase.pushResult({ studentId: _scope, lessonId: String(lessonId), ok: !!ok, err: err ? String(err) : '', act: act || 'test', at: now });
        if(typeof window.py10Firebase.pushSubmission === 'function'){
          window.py10Firebase.pushSubmission({ studentId: _scope, lessonId: String(lessonId), ok: !!ok, err: err ? String(err) : '', act: act || 'test', at: now, code: code || '', stdin: stdin || '', stdout: stdout || '' });
        }
      }
    }catch(e){}
  }
function indexOfProblem(id){ return PROBLEMS.findIndex(p=>p.id===id); }
  function isUnlockedByIndex(idx, progress){
    if(idx <= 0) return true;
    const prevId = PROBLEMS[idx-1].id;
    return !!(progress && progress.passed && progress.passed[prevId]);
  }
  function isUnlockedById(id, progress){ return isUnlockedByIndex(indexOfProblem(id), progress); }

  // =======================
  // Auto-save theo t·ª´ng b√†i (scope theo user)
  // =======================
  const CODE_KEY_PREFIX = `py10:${_scope}:code_v1_`;
  function loadSavedCode(problemId){
    try{
      const v = localStorage.getItem(CODE_KEY_PREFIX + problemId);
      return (v === null) ? null : v;
    }catch(_){ return null; }
  }
  function saveCode(problemId, code){ try{ localStorage.setItem(CODE_KEY_PREFIX + problemId, code ?? ""); }catch(_){}}
  let saveTimer = null;
  function scheduleSave(){
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{ saveCode(state.currentId, getCode()); }, 250);
  }

  // =======================
  // UI + State
  // =======================
  const elStdin = document.getElementById("stdin");
  const elOut = document.getElementById("out");
  const elRun = document.getElementById("runBtn");
  const elNext = document.getElementById("nextBtn");
  const elHint = document.getElementById("hintBtn");
  const elLoad = document.getElementById("loadBtn");
  const elStatus = document.getElementById("status");
  const elSelect = document.getElementById("problemSelect");
  const elPill = document.getElementById("pill");
  const elScoreMeta = document.getElementById("scoreMeta");
  const elSubtitle = document.getElementById("subtitle");
  const elCoachNext = document.getElementById("coachNext");
  const elCoachChecklist = document.getElementById("coachChecklist");
  const elStatementTitle = document.getElementById("statementTitle");
  const elStatementText = document.getElementById("statementText");

  let pyodide = null;
  const state = {
    currentId: PROBLEMS[0].id,
    hintClicks: 0,
    maxHint: 5,
    runCount: 0,
    lastRunHadError: false,
    lastRunPassed: false,
    lastErrText: "",
    failStreak: 0,
    liveTimer: null,
    lastSelectableId: PROBLEMS[0].id,
  };

  // =======================
  // Helpers
  // =======================
  function escapeHTML(s){ return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

  // =======================
  // Friendly error formatting (Pyodide / runtime)
  // - Gi√∫p HS th·∫•y ƒë√∫ng "l·ªói c·ªßa m√¨nh" (t√™n l·ªói + d√≤ng) thay v√¨ traceback n·ªôi b·ªô _pyodide.
  // - Gi·ªØ UI c≈©: ch·ªâ thay n·ªôi dung box Output/L·ªói.
  // =======================
  function _lastNonEmptyLine(s){
    const lines = String(s||"").replace(/\r\n/g,"\n").split("\n");
    for(let i=lines.length-1;i>=0;i--){
      const t = (lines[i]||"").trim();
      if(t) return t;
    }
    return "";
  }
  function _extractPyLine(trace){
    const m1 = String(trace||"").match(/File\s+"<exec>",\s*line\s*(\d+)/i);
    if(m1) return parseInt(m1[1],10);
    const m2 = String(trace||"").match(/line\s+(\d+)/i);
    if(m2) return parseInt(m2[1],10);
    return null;
  }
  function _extractPyTypeAndMsg(trace){
    const last = _lastNonEmptyLine(trace);
    const m = last.match(/^([A-Za-z_][A-Za-z0-9_]*)(?::\s*(.*))?$/);
    if(!m) return { type:"", msg:last };
    return { type: m[1]||"", msg: (m[2]||"").trim() };
  }
  function _codeLineAt(code, ln1){
    if(!ln1) return "";
    const lines = String(code||"").split(/\n/);
    const idx = ln1-1;
    if(idx<0 || idx>=lines.length) return "";
    return lines[idx];
  }
  function _viHintForPyError(type, msg){
    const t = String(type||"");
    const m = String(msg||"");
    // G·ª£i √Ω ng·∫Øn, kh√¥ng ƒë∆∞a l·ªùi gi·∫£i c·ª• th·ªÉ.
    if(t==="SyntaxError"){
      if(/EOL while scanning string literal/i.test(m)) return "B·∫°n ƒëang thi·∫øu d·∫•u nh√°y k·∫øt th√∫c chu·ªói (\" ho·∫∑c ').";
      if(/unexpected EOF/i.test(m)) return "B·∫°n ƒëang thi·∫øu d·∫•u ƒë√≥ng ngo·∫∑c ho·∫∑c thi·∫øu d√≤ng k·∫øt th√∫c kh·ªëi.";
      if(/invalid syntax/i.test(m)) return "Sai c√∫ ph√°p: ki·ªÉm tra d·∫•u : , ngo·∫∑c (), v√† th·ª© t·ª± c√¢u l·ªánh.";
      return "Sai c√∫ ph√°p: ki·ªÉm tra d·∫•u : , ngo·∫∑c (), th·ª•t l·ªÅ v√† vi·∫øt ƒë√∫ng l·ªánh.";
    }
    if(t==="IndentationError") return "L·ªói th·ª•t l·ªÅ: sau d·∫•u ':' ph·∫£i th·ª•t v√†o 4 kho·∫£ng (ho·∫∑c 1 tab) v√† c√°c d√≤ng trong kh·ªëi ph·∫£i th·∫≥ng h√†ng.";
    if(t==="NameError") return "B·∫°n ƒëang d√πng bi·∫øn/h√†m ch∆∞a ƒë∆∞·ª£c khai b√°o (vi·∫øt sai t√™n ho·∫∑c qu√™n t·∫°o bi·∫øn).";
    if(t==="TypeError") return "Sai ki·ªÉu d·ªØ li·ªáu: ki·ªÉm tra b·∫°n ƒëang c·ªông/tr·ª´/so s√°nh chu·ªói v·ªõi s·ªë, ho·∫∑c truy·ªÅn sai s·ªë tham s·ªë.";
    if(t==="ValueError") return "Gi√° tr·ªã nh·∫≠p v√†o kh√¥ng ƒë√∫ng d·∫°ng (v√≠ d·ª•: int(input()) nh∆∞ng ng∆∞·ªùi d√πng nh·∫≠p ch·ªØ).";
    if(t==="ZeroDivisionError") return "B·∫°n ƒëang chia cho 0. H√£y ki·ªÉm tra ƒëi·ªÅu ki·ªán ƒë·ªÉ tr√°nh b = 0 tr∆∞·ªõc khi chia.";
    if(t==="EOFError") return "Thi·∫øu d·ªØ li·ªáu nh·∫≠p (input). B√†i y√™u c·∫ßu nhi·ªÅu d√≤ng input h∆°n ph·∫ßn b·∫°n nh·∫≠p v√†o √¥ Input.";
    if(t==="IndexError") return "B·∫°n truy c·∫≠p ph·∫ßn t·ª≠ ngo√†i ph·∫°m vi (index). Ki·ªÉm tra ƒë·ªô d√†i danh s√°ch/chu·ªói tr∆∞·ªõc khi l·∫•y ph·∫ßn t·ª≠.";
    if(t==="KeyError") return "B·∫°n truy c·∫≠p key kh√¥ng t·ªìn t·∫°i trong dict.";
    if(t==="AttributeError") return "B·∫°n g·ªçi thu·ªôc t√≠nh/h√†m kh√¥ng t·ªìn t·∫°i tr√™n ƒë·ªëi t∆∞·ª£ng.";
    return "H√£y ƒë·ªçc d√≤ng l·ªói v√† ki·ªÉm tra l·∫°i ƒëi·ªÅu ki·ªán, input v√† c√¢u l·ªánh in ra (print).";
  }
  function formatSystemError(e, code){
    const raw = (e && (e.stack || e.message)) ? String(e.stack || e.message) : String(e);
    const s = raw.replace(/\r\n/g,"\n");

    // N·∫øu c√≥ traceback Python (th∆∞·ªùng b·ªã b·ªçc b·ªüi _pyodide), c·ªë g·∫Øng t√°ch l·ªói th·∫≠t.
    const hasTrace = /Traceback\s*\(most recent call last\)/i.test(s) || /PythonError/i.test(s) || /File\s+"<exec>"/i.test(s);
    if(hasTrace){
      const ln = _extractPyLine(s);
      const { type, msg } = _extractPyTypeAndMsg(s);
      const lineCode = ln ? _codeLineAt(code, ln) : "";
      const hint = _viHintForPyError(type, msg);

      const parts = [];
      parts.push(`<span class="x">‚ùå L·ªói:</span> <b>${escapeHTML(type||"L·ªói")}</b>${msg?`: ${escapeHTML(msg)}`:""}`);
      if(ln) parts.push(`<span class="muted">D√≤ng ${ln}${lineCode?`: <code>${escapeHTML(lineCode.trim())}</code>`:""}</span>`);
      parts.push(`<span class="hint">üí° G·ª£i √Ω:</span> ${escapeHTML(hint)}`);
      parts.push(`<details style="margin-top:8px"><summary class="muted">Chi ti·∫øt k·ªπ thu·∫≠t</summary><pre style="white-space:pre-wrap; margin:8px 0 0">${escapeHTML(s)}</pre></details>`);
      return parts.join("\n");
    }

    // Kh√¥ng c√≥ traceback -> hi·ªÉn th·ªã nh∆∞ c≈© nh∆∞ng v·∫´n c√≥ chi ti·∫øt.
    return `<span class="x">‚ùå L·ªói h·ªá th·ªëng:</span>\n${escapeHTML(e?.message || String(e))}`;
  }
  function setOutHTML(html){ elOut.innerHTML = html; }
  function setPill(text, kind){ elPill.textContent=text; elPill.className="pill"+(kind?(" "+kind):""); }
  function currentProblem(){ return PROBLEMS.find(p=>p.id===state.currentId); }

  // T√¨m b√†i k·∫ø ti·∫øp (ƒë√£ ƒë∆∞·ª£c m·ªü kh√≥a) theo th·ª© t·ª± danh s√°ch PROBLEMS.
  function findNextUnlockedId(){
    const idx = PROBLEMS.findIndex(p => p.id === state.currentId);
    const progress = loadProgress();
    for(let i = (idx < 0 ? 0 : idx + 1); i < PROBLEMS.length; i++){
      const id = PROBLEMS[i].id;
      if(isUnlockedById(id, progress)) return id;
    }
    return null;
  }

  function normalizeOutput(out){
    out=(out??"").replace(/\r\n/g,"\n");
    out=out.split("\n").map(l=>l.trimEnd()).join("\n");
    out=out.replace(/\n+$/g,"\n");
    return out;
  }
  function simplifyText(s){
    s=(s??"").toString().toLowerCase().trim();
    s=s.normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    s=s.replace(/\s+/g," ");
    return s;
  }
  function tokenize(out){
    const s=normalizeOutput(out).trim();
    if(!s) return [];
    return s.split(/\s+/).filter(Boolean);
  }
  function extractFirstNumber(s){
    const m=(s??"").toString().match(/-?\d+(\.\d+)?/);
    return m?Number(m[0]):null;
  }

  // =======================
  // Monaco setup
  // =======================
  let editor = null;
  function getCode(){ return editor ? editor.getValue() : ""; }
  function setCode(v){ if(editor) editor.setValue(v ?? ""); }
  function getCursorOffset(){
    if(!editor) return 0;
    const pos = editor.getPosition();
    return editor.getModel().getOffsetAt(pos);
  }

  const AC_WORDS = [
    { label:"print()", insertText:"print()", detail:"In k·∫øt qu·∫£" },
    { label:"input()", insertText:"input()", detail:"Nh·∫≠p d·ªØ li·ªáu" },
    { label:"int()", insertText:"int()", detail:"√âp ki·ªÉu int" },
    { label:"float()", insertText:"float()", detail:"√âp ki·ªÉu float" },
    { label:"if :", insertText:"if  :\n    ", detail:"R·∫Ω nh√°nh" },
    { label:"elif :", insertText:"elif  :\n    ", detail:"Nh√°nh ph·ª•" },
    { label:"else:", insertText:"else:\n    ", detail:"Nh√°nh c√≤n l·∫°i" },
    { label:"for i in range()", insertText:"for i in range():\n    ", detail:"V√≤ng l·∫∑p for" },
    { label:"while :", insertText:"while  :\n    ", detail:"V√≤ng l·∫∑p while" },
    { label:"range()", insertText:"range()", detail:"T·∫°o d√£y" },
  ];

  // =======================
  // Coach logic (gi·ªØ nguy√™n)
  // =======================
  function getCurrentLine(code, cursorPos){
    const left = code.slice(0, cursorPos);
    const lines = left.split("\n");
    return { line: lines.length, text: lines[lines.length-1] };
  }

  function hasDanglingBlock(code){
    const lines=(code||"").replace(/\r\n/g,"\n").split("\n");
    for(let i=0;i<lines.length;i++){
      const line=lines[i];
      const t=line.trim();
      if(!t || t.startsWith("#")) continue;
      const isBlock=/^(if|elif|else|for|while|def|try|except|finally|with)\b/.test(t) && t.endsWith(":");
      if(!isBlock) continue;

      let j=i+1;
      while(j<lines.length && lines[j].trim()==="") j++;
      if(j>=lines.length) return {ok:false,line:i+1,reason:"kh·ªëi l·ªánh b·ªã thi·∫øu n·ªôi dung (thi·∫øu th√¢n kh·ªëi)"};

      const next=lines[j];
      const indentNow=line.match(/^\s*/)[0].length;
      const indentNext=next.match(/^\s*/)[0].length;
      if(indentNext<=indentNow) return {ok:false,line:i+1,reason:"thi·∫øu th·ª•t l·ªÅ (thi·∫øu body sau d·∫•u ':')"};
    }
    return {ok:true};
  }

  function liveCoachHint(code, cursorPos, stdinSample){
    const { line, text } = getCurrentLine(code, cursorPos);
    const t = text.trim();
    const linesAll = code.split("\n");
    const nextLine = (linesAll[line] || "").trim();

    if (t === "else:" || t === "else") {
      return { level: "C·∫¢NH B√ÅO", message: `‚ö†Ô∏è D√≤ng ${line}: nh√°nh else ch∆∞a c√≥ n·ªôi dung.\nüëâ Sau "else:" b·∫°n ph·∫£i vi·∫øt l·ªánh v√† TH·ª§T L·ªÄ (4 d·∫•u c√°ch).` };
    }
    if (/^\s*else\s*:\s*$/.test(text) && nextLine && !/^\s+/.test(linesAll[line] || "")) {
      return { level:"C·∫¢NH B√ÅO", message:`‚ö†Ô∏è D√≤ng ${line}: sau else: d√≤ng d∆∞·ªõi ch∆∞a th·ª•t l·ªÅ.\nüëâ H√£y th·ª•t v√†o 4 d·∫•u c√°ch v√† vi·∫øt l·ªánh.` };
    }
    if (t.startsWith("if ") && !t.endsWith(":")) {
      return { level: "NH·∫ÆC NH·∫∏", message: `‚ö†Ô∏è D√≤ng ${line}: c√¢u l·ªánh if ƒëang thi·∫øu d·∫•u ":" ·ªü cu·ªëi.\nüëâ V√≠ d·ª•: if ... :` };
    }
    if ((t.startsWith("for ") || t.startsWith("while ") || t.startsWith("elif ")) && !t.endsWith(":")) {
      return { level:"NH·∫ÆC NH·∫∏", message:`‚ö†Ô∏è D√≤ng ${line}: d√≤ng n√†y ƒëang thi·∫øu d·∫•u ":" ·ªü cu·ªëi.\nüëâ Nh·ªõ th√™m ":" r·ªìi m·ªõi vi·∫øt ph·∫ßn th·ª•t l·ªÅ.` };
    }
    if (/int\s*\(\s*input\s*\(/.test(code)) {
      const sample = (stdinSample || "").trim().split("\n")[0] || "";
      if (sample && isNaN(Number(sample))) {
        return { level: "C·∫¢NH B√ÅO", message: `‚ùå B·∫°n ƒëang d√πng int(input()) nh∆∞ng d·ªØ li·ªáu m·∫´u KH√îNG ph·∫£i s·ªë.\nüëâ C√°ch s·ª≠a:\n- Nh·∫≠p s·ªë (v√≠ d·ª• 10)\n- Ho·∫∑c b·ªè int() n·∫øu b·∫°n c·∫ßn nh·∫≠p ch·ªØ` };
      }
    }

    const dangling = hasDanglingBlock(code);
    if (!dangling.ok) {
      return { level:"C·∫¢NH B√ÅO", message:`‚ö†Ô∏è B·∫°n ƒëang thi·∫øu th√¢n kh·ªëi sau d·∫•u ':' (kho·∫£ng d√≤ng ${dangling.line}).\nüëâ C√°ch s·ª≠a: th√™m 1 d√≤ng th·ª•t l·ªÅ b√™n d∆∞·ªõi (4 d·∫•u c√°ch) v√† vi·∫øt l·ªánh.` };
    }
    return null;
  }

  function analyzeProgress(problem, code){
    const c=code||"";
    const hasInput=/\binput\s*\(/.test(c);
    const hasPrint=/\bprint\s*\(/.test(c);
    const hasIf=/\bif\b/.test(c);
    const hasLoop=/\bfor\b|\bwhile\b/.test(c);
    const hasCast=/\bint\s*\(|\bfloat\s*\(|%|\/\/|\brange\s*\(/.test(c);
    const dangling=hasDanglingBlock(c);

    const checks=[
      {key:"input", label:"ƒê√£ ƒë·ªçc input", ok:hasInput},
      {key:"parse", label:"ƒê√£ √©p ki·ªÉu/x·ª≠ l√Ω d·ªØ li·ªáu", ok:hasCast},
      {key:"structure", label:"ƒê√£ d√πng if/for/while", ok:(hasIf||hasLoop)},
      {key:"print", label:"ƒê√£ in k·∫øt qu·∫£", ok:hasPrint},
    ];

    if(problem.id==="b1"){
      checks.push({key:"mod2", label:"C√≥ ki·ªÉm tra % 2", ok:/%\s*2/.test(c)});
      const elseLine = c.split("\n").findIndex(l=>/^\s*else\s*:\s*$/.test(l));
      let elseHasBody = true;
      if (elseLine >= 0){
        const lines=c.split("\n");
        let j=elseLine+1;
        while(j<lines.length && lines[j].trim()==="") j++;
        elseHasBody = j<lines.length && /^\s+/.test(lines[j]);
      }
      checks.push({key:"elseBody", label:"else c√≥ n·ªôi dung (th·ª•t l·ªÅ)", ok: elseLine<0 ? false : elseHasBody});
    }

    if(problem.id==="b2") checks.push({key:"mod", label:"C√≥ d√πng % ƒë·ªÉ ki·ªÉm tra chia h·∫øt", ok:/%/.test(c)});
    if(problem.id==="b3") checks.push({key:"branch", label:"C√≥ ƒë·ªß if/elif/else", ok:(/\bif\b/.test(c)&&/\belif\b/.test(c)&&/\belse\b/.test(c))});
    if(problem.id==="b4") checks.push({key:"loop", label:"C√≥ v√≤ng l·∫∑p", ok:hasLoop});
    if(problem.id==="b5"){
      checks.push({key:"even", label:"L·ªçc ch·∫µn b·∫±ng %2", ok:/%\s*2/.test(c)});
      checks.push({key:"loop2", label:"C√≥ v√≤ng l·∫∑p c·ªông d·ªìn", ok:hasLoop});
    }

    let next="";
    if(!dangling.ok){
      next=`‚ö†Ô∏è ∆Øu ti√™n s·ª≠a c·∫•u tr√∫c: thi·∫øu th√¢n kh·ªëi sau ':' (d√≤ng ${dangling.line}).\nüëâ Sau d√≤ng c√≥ ':' ph·∫£i c√≥ d√≤ng th·ª•t l·ªÅ b√™n d∆∞·ªõi.`;
      return {checks,next};
    }

    const live = liveCoachHint(c, getCursorOffset(), elStdin.value);
    if(live) return {checks, next:`üß† ${live.level}\n${live.message}`};

    const firstNo = checks.find(x=>!x.ok);
    const map={
      input:"B∆∞·ªõc ti·∫øp theo: ƒë·ªçc input ƒë√∫ng s·ªë l∆∞·ª£ng d·ªØ li·ªáu (input()).",
      parse:"B∆∞·ªõc ti·∫øp theo: √©p ki·ªÉu (int/float) ho·∫∑c x·ª≠ l√Ω d·ªØ li·ªáu.",
      structure:"B∆∞·ªõc ti·∫øp theo: ch·ªçn c·∫•u tr√∫c if/for/while ph√π h·ª£p.",
      print:"B∆∞·ªõc ti·∫øp theo: in k·∫øt qu·∫£ cu·ªëi c√πng (print).",
      mod2:"B∆∞·ªõc ti·∫øp theo: d√πng %2 ƒë·ªÉ x√©t ch·∫µn/l·∫ª.",
      elseBody:"B∆∞·ªõc ti·∫øp theo: vi·∫øt n·ªôi dung cho nh√°nh else (th·ª•t l·ªÅ).",
      mod:"B∆∞·ªõc ti·∫øp theo: ki·ªÉm tra chia h·∫øt b·∫±ng a % b.",
      branch:"B∆∞·ªõc ti·∫øp theo: chia 3 tr∆∞·ªùng h·ª£p b·∫±ng if/elif/else.",
      loop:"B∆∞·ªõc ti·∫øp theo: th√™m v√≤ng l·∫∑p ƒë·ªÉ in 1..n.",
      even:"B∆∞·ªõc ti·∫øp theo: l·ªçc s·ªë ch·∫µn b·∫±ng %2.",
      loop2:"B∆∞·ªõc ti·∫øp theo: th√™m v√≤ng l·∫∑p ƒë·ªÉ c·ªông d·ªìn."
    };
    next = firstNo ? (map[firstNo.key] || "B∆∞·ªõc ti·∫øp theo: l√†m theo t·ª´ng b∆∞·ªõc c·ªßa ƒë·ªÅ.")
                   : (state.lastRunPassed ? "‚úÖ ƒê·ªß b∆∞·ªõc c∆° b·∫£n. N·∫øu FAIL: ki·ªÉm tra ƒëi·ªÅu ki·ªán bi√™n + ch·ªØ output."
                                         : "‚úÖ ƒê·ªß b∆∞·ªõc c∆° b·∫£n. H√£y b·∫•m Test ƒë·ªÉ ki·ªÉm tra test case.");
    return {checks,next};
  }

  function updateCoach(){
    const p=currentProblem();
    const {checks,next}=analyzeProgress(p, getCode());
    elCoachChecklist.innerHTML = checks.map(c => `<li>${c.ok?`<span class="ok">‚úÖ</span>`:`<span class="no">‚¨ú</span>`} ${escapeHTML(c.label)}</li>`).join("");
    elCoachNext.textContent = next;
  }

  function debounceCoach(ms=200){
    if(state.liveTimer) clearTimeout(state.liveTimer);
    state.liveTimer=setTimeout(updateCoach, ms);
  }

  // =======================
  // Error ti·∫øng Vi·ªát
  // =======================
  function classifyPythonError(stderr){
    const s = (stderr||"").toString();
    if (s.includes("SyntaxError")) return "SyntaxError";
    if (s.includes("IndentationError")) return "IndentationError";
    if (s.includes("ValueError")) return "ValueError";
    if (s.includes("EOFError")) return "EOFError";
    return "Other";
  }
  function extractLineNoFromTrace(stderr){
    const s=(stderr||"").toString().split("\n");
    for(const ln of s){
      const m=ln.match(/line\s+(\d+)/);
      if(m) return parseInt(m[1],10);
    }
    return null;
  }
  function extractErrTypeMsg(stderr){
    const lines=(stderr||"").toString().split("\n").map(x=>x.trim()).filter(Boolean);
    for(let i=lines.length-1;i>=0;i--){
      const m=lines[i].match(/^([A-Za-z_]+Error|Exception):\s*(.*)$/);
      if(m) return {type:m[1], msg:m[2]||""};
    }
    return {type:"Error", msg:(lines[lines.length-1]||"")};
  }
  function viExplainByDisease(stderr, code){
    const type = classifyPythonError(stderr);
    const lineNo = extractLineNoFromTrace(stderr);
    const { msg } = extractErrTypeMsg(stderr);

    const codeLines = (code||"").split("\n");
    let around = "";
    if (lineNo != null){
      const start = Math.max(1, lineNo-1);
      const end = Math.min(codeLines.length, lineNo+1);
      const arr=[];
      for(let i=start;i<=end;i++){
        arr.push(`${i===lineNo?"üëâ":"  "} ${i} | ${codeLines[i-1]??""}`);
      }
      around = "\nüìå Code quanh d√≤ng l·ªói:\n" + arr.join("\n");
    }

    const m = (msg||"").toLowerCase();

    if (type === "SyntaxError"){
      let reason = "B·∫°n vi·∫øt sai c√∫ ph√°p Python.";
      let fix = "- Ki·ªÉm tra d·∫•u ':' sau if/elif/else/for/while\n- Ki·ªÉm tra c·∫∑p ngo·∫∑c ()\n- Ki·ªÉm tra d·∫•u nh√°y ' \" c√≥ ƒë·ªß c·∫∑p";
      if (m.includes("expected ':'")) { reason="Thi·∫øu d·∫•u ':' ·ªü cu·ªëi d√≤ng ƒëi·ªÅu khi·ªÉn (if/for/while/elif/else)."; fix="- Th√™m ':' ·ªü cu·ªëi d√≤ng ƒë√≥\n- D√≤ng sau ph·∫£i th·ª•t l·ªÅ"; }
      if (m.includes("eol while scanning string literal") || m.includes("unterminated string")) { reason="Thi·∫øu d·∫•u nh√°y ƒë√≥ng chu·ªói (\" ho·∫∑c ')."; fix="- Ki·ªÉm tra chu·ªói b·∫°n ƒëang vi·∫øt\n- ƒê·∫£m b·∫£o c√≥ ƒë·ªß c·∫∑p d·∫•u nh√°y"; }
      if (m.includes("was never closed") || m.includes("unexpected eof")) { reason="Thi·∫øu d·∫•u ')' ho·∫∑c ']' ho·∫∑c '}'."; fix="- Ki·ªÉm tra ngo·∫∑c m·ªü/ƒë√≥ng\n- ƒê·∫øm s·ªë ngo·∫∑c () [] {}"; }
      return `‚ùå L·ªñI C√ö PH√ÅP (SyntaxError)\nüìç V·ªã tr√≠: d√≤ng ${lineNo ?? "?"}\nüí¨ V√¨ sao l·ªói: ${reason}\n‚úÖ C√°ch s·ª≠a:\n${fix}${around}\n\nüìå Chi ti·∫øt l·ªói:\n${stderr}`;
    }

    if (type === "IndentationError"){
      return `‚ùå L·ªñI TH·ª§T L·ªÄ (IndentationError)\nüìç V·ªã tr√≠: d√≤ng ${lineNo ?? "?"}\nüí¨ V√¨ sao l·ªói: Sau d√≤ng c√≥ ':' b·∫°n ch∆∞a th·ª•t l·ªÅ/thi·∫øu th√¢n kh·ªëi.\n‚úÖ C√°ch s·ª≠a:\n- Sau if/else/for/while...: ph·∫£i c√≥ d√≤ng TH·ª§T V√ÄO 4 d·∫•u c√°ch\n- Kh√¥ng tr·ªôn TAB v√† SPACE\n${around}\n\nüìå Chi ti·∫øt l·ªói:\n${stderr}`;
    }

    if (type === "ValueError"){
      return `‚ùå L·ªñI √âP KI·ªÇU (ValueError)\nüìç V·ªã tr√≠: d√≤ng ${lineNo ?? "?"}\nüí¨ V√¨ sao l·ªói: B·∫°n d√πng int()/float() v·ªõi d·ªØ li·ªáu kh√¥ng ph·∫£i s·ªë.\n‚úÖ C√°ch s·ª≠a:\n- Nh·∫≠p ƒë√∫ng s·ªë (v√≠ d·ª• 10)\n- Ho·∫∑c b·ªè int()/float() n·∫øu c·∫ßn nh·∫≠p ch·ªØ\n${around}\n\nüìå Chi ti·∫øt l·ªói:\n${stderr}`;
    }

    if (type === "EOFError"){
      return `‚ùå L·ªñI THI·∫æU INPUT (EOFError)\nüìç V·ªã tr√≠: d√≤ng ${lineNo ?? "?"}\nüí¨ V√¨ sao l·ªói: Ch∆∞∆°ng tr√¨nh c·∫ßn nhi·ªÅu input h∆°n s·ªë d√≤ng b·∫°n nh·∫≠p.\n‚úÖ C√°ch s·ª≠a:\n- Nh·∫≠p ƒë·ªß s·ªë d√≤ng input theo ƒë·ªÅ\n- V√≠ d·ª• b√†i 2 c·∫ßn 2 d√≤ng: a v√† b\n${around}\n\nüìå Chi ti·∫øt l·ªói:\n${stderr}`;
    }

    return `‚ùå L·ªñI KH√ÅC\nüìç V·ªã tr√≠: d√≤ng ${lineNo ?? "?"}\n‚úÖ C√°ch x·ª≠ l√Ω:\n- ƒê·ªçc d√≤ng b√°o l·ªói cu·ªëi c√πng v√† s·ª≠a ƒë√∫ng ch·ªó tr∆∞·ªõc\n${around}\n\nüìå Chi ti·∫øt l·ªói:\n${stderr}`;
  }

  // =======================
  // Runner
  // =======================
  function pyTripleQuoteSafe(s){
    return (s ?? "").replaceAll("\\", "\\\\").replaceAll('"""', '\\"""');
  }

  async function runPythonWithInput(code, inputStr){
    if(!pyodide) throw new Error("Pyodide ch∆∞a s·∫µn s√†ng");

    const indented = (code||"").split("\n").map(l=>"    "+l).join("\n");
    const py = `\nimport sys, io, traceback, builtins\n__in = """${pyTripleQuoteSafe(inputStr)}"""\nsys.stdin = io.StringIO(__in)\nsys.stdout = io.StringIO()\nsys.stderr = io.StringIO()\n\ndef _silent_input(prompt=None):\n    return sys.stdin.readline().rstrip("\\n")\nbuiltins.input = _silent_input\n\ntry:\n${indented}\nexcept Exception:\n    traceback.print_exc()\n\n__out = sys.stdout.getvalue()\n__err = sys.stderr.getvalue()\n`;
    await pyodide.runPythonAsync(py);
    return {
      out: pyodide.globals.get("__out") || "",
      err: pyodide.globals.get("__err") || ""
    };
  }

  async function gradeProblem(problem, code){
    const allTests = [
      ...(problem.tests.public||[]).map(t=>({...t,__public:true})),
      ...(problem.tests.hidden||[]).map(t=>({...t,__public:false}))
    ];
    let passCount=0;
    for(let i=0;i<allTests.length;i++){
      const t=allTests[i];
      const {out,err}=await runPythonWithInput(code,t.input);
      if(err && err.trim()){
        return { pass:false, runtimeError:true, passCount, total:allTests.length, failedAt:i+1, out, err, test:t };
      }
      let ok=false;
      ok = problem.checker ? problem.checker(out,t.expected,t.input,t) : (tokenize(out).join(" ")===tokenize(String(t.expected)).join(" "));
      if(!ok){
        return { pass:false, runtimeError:false, passCount, total:allTests.length, failedAt:i+1, out, err:"", test:t };
      }
      passCount++;
    }
    return { pass:true, runtimeError:false, passCount:allTests.length, total:allTests.length, failedAt:null };
  }

  // =======================
  // Hint engine
  // =======================
  function chooseHintLevel(problem){
    const code = getCode().trim();
    const nonEmpty = code ? code.split("\n").filter(l=>l.trim()).length : 0;
    const dangling = hasDanglingBlock(code);
    if(!dangling.ok) return 5;
    if(state.lastRunHadError) return 5;
    if(!code || nonEmpty<2 || code.length<25) return 1;
    if(state.runCount===0) return 2;
    if(!state.lastRunPassed) return (state.failStreak>=2 ? 4 : 3);
    return 1;
  }
  function pickHint(problem, level){
    const arr = (problem.hints && problem.hints["level"+level]) ? problem.hints["level"+level] : [];
    return arr.length ? arr[Math.floor(Math.random()*arr.length)] : "Ch∆∞a c√≥ g·ª£i √Ω cho m·ª©c n√†y.";
  }

  // =======================
  // Render + events
  // =======================
  function initSelect(){
    const progress = loadProgress();
    elSelect.innerHTML = PROBLEMS.map((p, idx)=>{
      const unlocked = isUnlockedByIndex(idx, progress);
      const passed = !!(progress.passed && progress.passed[p.id]);
      const label = `${p.title}${passed ? " ‚úÖ" : (unlocked ? "" : " üîí")}`;
      return `<option value="${p.id}" ${unlocked ? "" : "disabled"}>${escapeHTML(label)}</option>`;
    }).join("");
    elSelect.value = state.currentId;
  }

  function renderProblem(p){
    elSubtitle.textContent = p.statement;
    elStatementTitle.textContent = p.title;
    elStatementText.textContent = p.statement;

    const saved = loadSavedCode(p.id);
    setCode((saved !== null && saved.trim() !== "") ? saved : p.starter);

    elStdin.value = p.sampleInput||"";
    state.hintClicks=0; state.lastRunHadError=false; state.lastRunPassed=false; state.lastErrText=""; state.failStreak=0; state.runCount=0;

    // M·∫∑c ƒë·ªãnh ·∫©n n√∫t "B√†i ti·∫øp theo" (ch·ªâ hi·ªán khi PASS).
    if(elNext) elNext.style.display = 'none';

    setPill("Ch∆∞a ch·∫°y","");
    setOutHTML(`<span class="muted">Ch∆∞a ch·∫°y.</span>`);

    const total=(p.tests.public.length+p.tests.hidden.length);
    elScoreMeta.textContent=`Test: 0/${total}`;

    updateCoach();
  }

  elSelect.addEventListener("change",()=>{
    const desiredId = elSelect.value;
    const progress = loadProgress();

    if(!isUnlockedById(desiredId, progress)){
      elSelect.value = state.lastSelectableId;
      setOutHTML(
        `<span class="x">üîí B√†i n√†y ƒëang b·ªã kh√≥a.</span>\n`+
        `<span class="hint">B·∫°n c·∫ßn PASS b√†i tr∆∞·ªõc r·ªìi m·ªõi m·ªü b√†i ti·∫øp theo.</span>`
      );
      return;
    }

    state.currentId = desiredId;
    state.lastSelectableId = desiredId;
    renderProblem(currentProblem());
  });

  elLoad.addEventListener("click",()=>{
    const p=currentProblem();
    setCode(p.starter);
    setOutHTML(`<span class="hint">üí° ƒê√£ n·∫°p khung code.</span>`);
    debounceCoach(0);
  });

  elHint.addEventListener("click",()=>{
    const p=currentProblem();
    if(state.hintClicks>=state.maxHint){
      setOutHTML(`<span class="hint">üí° B·∫°n ƒë√£ d√πng h·∫øt g·ª£i √Ω.</span>\n<span class="muted">H√£y xem checklist v√† s·ª≠a t·ª´ng b∆∞·ªõc.</span>`);
      return;
    }
    state.hintClicks++;
    const level=chooseHintLevel(p);

    const live = liveCoachHint(getCode(), getCursorOffset(), elStdin.value);
    if(live){
      setOutHTML(`<span class="hint">üí° G·ª£i √Ω t·ª©c th√¨</span>\n\n${escapeHTML(live.message)}`);
      return;
    }

    const hint = pickHint(p, level);
    setOutHTML(`<span class="hint">üí° G·ª£i √Ω Level ${level}</span>\n\n${escapeHTML(hint)}`);
  });

  elRun.addEventListener("click", async ()=>{
    const p=currentProblem();
    const code=getCode();
    const stdin=elStdin.value;

    setPill("ƒêang test...","");
    setOutHTML(`<span class="muted">ƒêang ch·∫°y th·ª≠ + test...</span>`);
    elRun.disabled=true;

    try{
      state.runCount++;

      const trial = await runPythonWithInput(code, stdin);
      if(trial.err && trial.err.trim()){
        state.lastRunHadError=true; state.lastRunPassed=false; state.lastErrText=trial.err; state.failStreak++;
        setPill("L·ªói khi ch·∫°y","bad");
        const explained = viExplainByDisease(trial.err, code);
        setOutHTML(`<span class="x">${escapeHTML(explained)}</span>`);
        // ƒê·ªìng b·ªô l·ªói ch·∫°y l√™n b·∫£ng K·∫øt qu·∫£ c·ªßa GV
        syncTeacherResult({ lessonId: state.currentId, ok: false, err: trial.err, act: "test", code, stdin, stdout: "" });
        updateCoach();
        return;
      }

      state.lastRunHadError=false; state.lastErrText="";

      const grade = await gradeProblem(p, code);
      elScoreMeta.textContent = `Test: ${grade.passCount}/${grade.total}`;

      const trialOut = normalizeOutput(trial.out);

      if(grade.pass){
        state.lastRunPassed=true; state.failStreak=0;
        setPill("PASS ‚úÖ","ok");
        setOutHTML(`<span class="ok">‚úÖ PASS</span>  <span class="muted">(ƒê√∫ng theo test case)</span>\n\n${escapeHTML(trialOut || "(Kh√¥ng c√≥ output)")}`);

        const prog = loadProgress();
        prog.passed = prog.passed || {};
        prog.passed[p.id] = true;
        saveProgress(prog);
        // ƒê·ªìng b·ªô PASS l√™n b·∫£ng K·∫øt qu·∫£ c·ªßa GV
        syncTeacherResult({ lessonId: p.id, ok: true, err: "", act: "test", code, stdin, stdout: trialOut });
        state.lastErrText = "";

        initSelect();
        state.lastSelectableId = state.currentId;

        // PASS: KH√îNG t·ª± nh·∫£y b√†i. Ch·ªâ hi·ªán n√∫t "B√†i ti·∫øp theo" ƒë·ªÉ h·ªçc sinh b·∫•m.
        const nextId = findNextUnlockedId();
        if(nextId && elNext){
          elNext.style.display = 'inline-flex';
          elNext.disabled = false;
          elNext.onclick = () => {
            elNext.style.display = 'none';
            elSelect.value = nextId;
            elSelect.dispatchEvent(new Event('change'));
          };
        } else if(elNext){
          elNext.style.display = 'none';
        }

      } else {
        state.lastRunPassed=false; state.failStreak++;
        setPill("FAIL ‚ùå","bad");

        const dangling = hasDanglingBlock(code);
        let reason = "";
        if(!dangling.ok){
          reason = `B·∫°n ƒëang thi·∫øu th√¢n kh·ªëi sau ':' (d√≤ng ${dangling.line}). H√£y th·ª•t l·ªÅ v√† vi·∫øt l·ªánh trong nh√°nh ƒë√≥.`;
        } else {
          if(p.id==="b1" && !/%\s*2/.test(code)) reason="G·ª£i √Ω: ch·∫µn/l·∫ª th∆∞·ªùng d√πng % 2 ƒë·ªÉ ki·ªÉm tra.";
          else if(p.id==="b1" && !/\belse\b/.test(code)) reason="G·ª£i √Ω: b√†i ch·∫µn/l·∫ª th∆∞·ªùng c·∫ßn if/else ƒë·ªÉ c√≥ 2 tr∆∞·ªùng h·ª£p.";
          else reason="G·ª£i √Ω: ki·ªÉm tra ƒëi·ªÅu ki·ªán bi√™n, c·∫•u tr√∫c if/loop v√† ch·ªØ b·∫°n in ra.";
        }

        setOutHTML(
          `<span class="x">‚ùå FAIL</span> <span class="muted">(Tr∆∞·ª£t ·ªü test #${grade.failedAt})</span>\n`+
          `<span class="hint">üí° G·ª£i √Ω s·ª≠a nh·∫π:</span> ${escapeHTML(reason)}\n\n`+
          `${escapeHTML(trialOut || "(Kh√¥ng c√≥ output)")}`
        );
        state.lastErrText = `FAIL test #${grade.failedAt}. ${reason}`;
        // ƒê·ªìng b·ªô FAIL l√™n b·∫£ng K·∫øt qu·∫£ c·ªßa GV
        syncTeacherResult({ lessonId: p.id, ok: false, err: state.lastErrText, act: "test", code, stdin, stdout: trialOut });
      }

      updateCoach();

    } catch(e){
      setPill("L·ªói h·ªá th·ªëng","bad");
      setOutHTML(formatSystemError(e, getCode()));
      updateCoach();
    } finally {
      elRun.disabled=false;
    }
  });

  // =======================
  // Boot
  // =======================
  function bootUI(){
    initSelect();

    const progress = loadProgress();
    if(!isUnlockedById(state.currentId, progress)) state.currentId = PROBLEMS[0].id;
    state.lastSelectableId = state.currentId;
    elSelect.value = state.currentId;

    renderProblem(currentProblem());
  }

  function enableUIReady(){
    elStatus.textContent="S·∫µn s√†ng";
    setPill("Ch∆∞a ch·∫°y","");
    elRun.disabled=false;
    elHint.disabled=false;
    elLoad.disabled=false;
    updateCoach();
  }

  require.config({ paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs" } });

  require(["vs/editor/editor.main"], async function () {
    editor = monaco.editor.create(document.getElementById("editor"), {
      value: PROBLEMS[0].starter,
      language: "python",
      theme: "vs",
      automaticLayout: true,
      minimap: { enabled: false },
      fontSize: 14,
      lineHeight: 21,
      fontFamily: 'ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace',
      scrollBeyondLastLine: false,
      wordWrap: "off",
      tabSize: 4,
      insertSpaces: true,
    });

    monaco.languages.registerCompletionItemProvider("python", {
      provideCompletionItems: function(model, position) {
        const suggestions = AC_WORDS.map(w => ({
          label: w.label,
          kind: monaco.languages.CompletionItemKind.Snippet,
          insertText: w.insertText,
          detail: w.detail,
          range: undefined
        }));
        return { suggestions };
      }
    });

    editor.onDidChangeModelContent(() => {
      scheduleSave();
      debounceCoach(120);
    });

    editor.onDidChangeCursorPosition(() => {
      debounceCoach(0);
    });

    
  // Expose snapshot for outer shell (help tickets)
  window.__py10GetSnapshot = function(){
    try{
      const p = (typeof currentProblem === "function") ? currentProblem() : null;
      return {
        lessonId: (state && state.currentId) ? state.currentId : "",
        lessonTitle: p && p.title ? p.title : "",
        code: (typeof getCode === "function") ? getCode() : "",
        lastError: (state && state.lastErrText) ? state.lastErrText : "",
        lastStatus: (state && state.lastStatusText) ? state.lastStatusText : "",
        lastOutput: (typeof getOutputText === "function") ? getOutputText() : "",
      };
    } catch(e){
      return { lessonId:"", lessonTitle:"", code:"", lastError:String(e||""), lastStatus:"", lastOutput:"" };
    }
  };

  function getOutputText(){
    try{
      const el = document.getElementById("outBox");
      if(!el) return "";
      return (el.innerText || "").trim();
    }catch(e){ return ""; }
  }

bootUI();


    // =======================
    // B√†i GV giao: t·ª± c·∫≠p nh·∫≠t danh s√°ch (khi GV v·ª´a giao/ s·ª≠a ƒë·ªÅ)
    // =======================
    let __lastAssignRaw = "";
    let __lastBankRaw = "";
    try{
      __lastAssignRaw = localStorage.getItem(ASSIGN_KEY) || "";
      __lastBankRaw = localStorage.getItem(TEACHER_BANK_KEY) || "";
    }catch(e){}

    function refreshAssignedProblems(){
      try{
        const aRaw = localStorage.getItem(ASSIGN_KEY) || "";
        const bRaw = localStorage.getItem(TEACHER_BANK_KEY) || "";
        if(aRaw === __lastAssignRaw && bRaw === __lastBankRaw) return;
        __lastAssignRaw = aRaw;
        __lastBankRaw = bRaw;

        // L∆∞u nh√°p ƒë·ªÉ kh√¥ng m·∫•t ƒëo·∫°n ƒëang g√µ
        try{ saveCode(state.currentId, getCode()); }catch(_){}

        const curId = state.currentId;
        rebuildProblemsFromAssignments();
        initSelect();

        if(PROBLEMS.some(p=>p.id===curId)){
          // Gi·ªØ nguy√™n b√†i ƒëang l√†m
          elSelect.value = curId;
        }else{
          // B√†i ƒëang l√†m b·ªã x√≥a/t·∫Øt -> quay v·ªÅ b√†i h·ª£p l·ªá g·∫ßn nh·∫•t
          const progress = loadProgress();
          let fallback = PROBLEMS[0].id;
          for(const p of PROBLEMS){
            if(isUnlockedById(p.id, progress)){ fallback = p.id; break; }
          }
          state.currentId = fallback;
          state.lastSelectableId = fallback;
          elSelect.value = fallback;
          renderProblem(currentProblem());
        }
      }catch(err){
        console.warn("refreshAssignedProblems failed", err);
      }
    }

    // storage event: khi GV thao t√°c ·ªü tab kh√°c
    try{
      window.addEventListener("storage", (e)=>{
        if(!e) return;
        if(e.key === ASSIGN_KEY || e.key === TEACHER_BANK_KEY){
          setTimeout(refreshAssignedProblems, 80);
        }
      });
    }catch(e){}

    // Poll nh·∫π: khi m·ªôt s·ªë tr√¨nh duy·ªát/tab kh√¥ng b·∫Øn event
    setInterval(()=>{ try{ refreshAssignedProblems(); }catch(e){} }, 1500);

    elStatus.textContent="ƒêang t·∫£i Python...";
    setPill("ƒêang t·∫£i...","");
    pyodide = await loadPyodide();
    enableUIReady();
  });
</script>

</body>
</html>
